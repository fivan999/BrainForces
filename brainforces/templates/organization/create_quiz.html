{% extends "organization/detail.html" %}

{% block styles %}
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

  <!-- Font Awesome -->
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

  <!-- Moment.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.23.0/moment.min.js" integrity="sha256-VBLiveTKyUZMEzJd6z2mhfxIqz3ZATCuVMawPZGzIfA=" crossorigin="anonymous"></script>

  <!-- Tempus Dominus Bootstrap 4 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.1.2/css/tempusdominus-bootstrap-4.min.css" integrity="sha256-XPTBwC3SBoWHSmKasAk01c08M6sIA5gF5+sRxqak2Qs=" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.1.2/js/tempusdominus-bootstrap-4.min.js" integrity="sha256-z0oKYg6xiLq3yJGsp/LsY9XykbweQlHl42jHv2XTBz4=" crossorigin="anonymous"></script>
{% endblock %}

{% load widget_tweaks %}

{% block organization_page %}
  <form enctype="multipart/form-data" method="post">
    {% csrf_token %}
    <div id="forms-container">
      <div class="card mb-4">
        <div class="card-header card-header-secondary">
          <h4 class="card-title">Создать викторину</h4>
        </div>
        <div class="card-body p-2">
          {% for error in form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
              {{ error|safe }}
            </div>
          {% endfor %}
          {% for field in form.visible_fields %}
            <p>
              {{ field.label }}
              {% if field.name == 'description' %}
                {{ field }}<br/>
              {% elif field.name == 'start_time' %}
                <div class="input-group date gap-2" id="datetimepicker1" data-target-input="nearest">
                  {{ field }}
                  <div class="input-group-append d-flex" data-target="#datetimepicker1" data-toggle="datetimepicker">
                    <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                  </div>
                </div>
              {% elif field.name == 'is_private' or field.name == 'is_rated' %}
                {{ field|add_class:'form-check-input' }}
              {% else %}
                {{ field|add_class:'form-control' }}
              {% endif %}
              <small><span class="text-muted">{{ field.help_text }}</span></small>
              {% for error in field.errors %}
                <div class="alert alert-danger" role="alert">
                  {{ error|safe }}
                </div>
              {% endfor %}
            </p>
          {% endfor %}
        </div>
      </div>
      {{ question_formset.management_form }}
      {% for error in question_formset.non_form_errors %}
        <div class="alert alert-danger" role="alert">
          {{ error|safe }}
        </div>
      {% endfor %}
      {% for form in question_formset %}
        <div class="card mb-4" name="question-form">
          <div class="card-header card-header-secondary">
            <h4 class="card-title">Добавить вопрос {{ forloop.counter }}</h4>
          </div>
          <div class="card-body p-2">
            {% for field in form.visible_fields %}
              <p>
                {% if field.name != 'DELETE' %}
                  {{ field.label }}
                  {% if field.name == 'is_correct' %}
                    {{ field|add_class:'form-check-input' }}
                  {% elif field.name == 'text' %}
                    {{ field }}<br/>
                  {% else %}
                    {{ field|add_class:'form-control' }}
                  {% endif %}
                  <small><span class="text-muted">{{ field.help_text }}</span></small>
                  {% for error in field.errors %}
                    <div class="alert alert-danger" role="alert">
                      {{ error|safe }}
                    </div>
                  {% endfor %}
                {% endif %}
              </p>
            {% endfor %}
            {% comment %} <a class="btn btn-danger mb-3" name="delete-question">Удалить вопрос</a> {% endcomment %}
          </div>
        </div>
      {% endfor %}
    </div>
    <a class="btn btn-success mb-3" id="add-question">Добавить вопрос</a>
    <button type="submit" class="btn btn-primary mb-3">Создать</button>
  </form>
  <script>
    // выбор даты и времени
    $(function pick_quiz_datetime() { 
      $("#datetimepicker1").datetimepicker({
        format: 'DD.MM.YYYY HH:mm:ss',
      });
    });

    // в самом начале оставляем только одну форму с вопросом, остальные прячем
    window.addEventListener('DOMContentLoaded', function hide_question_forms() { 
      var now_forms = document.getElementById("id_quiz_question-TOTAL_FORMS");
      now_forms.value = 1;
      var questions = document.querySelectorAll('div.card.mb-4[name="question-form"]');
      for (let i = 1; i < 51; i++) {
        questions[i].hidden = 1;
      }
    });

    // добавляем форму с вопросом
    document.getElementById("add-question").onclick = function show_question_form() {
      var max_forms = document.getElementById("id_quiz_question-MAX_NUM_FORMS");
      var now_forms = document.getElementById("id_quiz_question-TOTAL_FORMS");
      if (parseInt(now_forms.value) < parseInt(max_forms.value)){
        now_forms.value = parseInt(now_forms.value) + 1;
        var question = document.querySelector('div.card.mb-4[name="question-form"][hidden]');
        question.removeAttribute("hidden");
      }
      else{
        alert("Слишком много вопросов");
      }
    };

    {% comment %} // удаляем форму с вопросом
    var delete_btns = document.querySelectorAll('a[name="delete-question"]');
    delete_btns.forEach(btn => {
      btn.addEventListener('click', (event)=> {
          var now_forms = document.getElementById("id_quiz_question-TOTAL_FORMS");
          if (parseInt(now_forms.value) > 1){
            var question_to_hide = event.target.parentElement.parentElement;
            question_to_hide.hidden = 1;
            now_forms.value = parseInt(now_forms.value) - 1;
          }
          else{
            alert("Слишком мало вопросов");
          }
        }
      );
    }); {% endcomment %}

    // удаляем ненужные формы при отправке формы
    document.querySelector('button[type="submit"]').onclick = function delete_extra_forms() {
      var extra_forms = document.querySelectorAll('div.card.mb-4[name="question-form"][hidden]');
      extra_forms.forEach(form => {
        form.parentNode.removeChild(form);
      })
    }

  </script>
{% endblock organization_page %}